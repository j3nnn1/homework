<html lang="en">
    <head>
       <meta charset="utf-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>Remuneraci&oacute;n Anual por Sector</title>
       <!-- <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
       <script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
       <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script> -->
       <script src="js/jquery.js"></script>
       <script src="js/bootstrap.js"></script>
       <script type="text/javascript" src="js/d3.v3.min.js"></script>
       <script type="text/javascript" src="js/topojson.v1.min.js"></script>
       <script type="text/javascript" src="js/queue.v1.min.js"></script> 
       <script type="text/javascript" src="js/jquery.tipsy.js"></script>
       <script type="text/javascript" src="js/colorbrewer/colorbrewer.js"></script>

       <link href="css/bootstrap-responsive.css" rel="stylesheet">
       <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
       <link rel="stylesheet" href="css/mapa.css">
       </head>
       <body>
           <div class="navbar  navbar-static-top">
           <div class="navbar-inner">
               <a class="brand" href="index.html">Visualizaciones</a>
		    <ul class="nav">
			<li><a href="#">Integrantes</a></li>
			<li class="divider-vertical"></li>
			<li class="divider-vertical"></li>
			<li><a href="empleo_sector.html">Empleo Anual Por Sector</a></li>
			<li><a href="http://78.47.89.42:8100">Empleo Trimestral por provincia</a></li>
			<li><a href="mapa.html">Remuración Anual por Sector</a></li>
			<li><a href="maps_desocupacion.html">Coordenadas Paralelas</a></li>
			<li class="divider-vertical"></li>
			<li><a href="#">Referencias</a></li>
		    </ul>
           </div>
           </div>
           <script type="text/javascript">
           $(document).ready(function(){

           var width = 800,
               height = 600;
           var color = new Array();
               color['Empleo'] = "green";
               color['Desocupacion'] = "red";

           //coloring by activity,
           //var scale_color_provinces =  colorbrewer.Blues[9].reverse().concat(colorbrewer.YlGn[9]);
           var scale_color_provinces =  colorbrewer.Blues[9];
	   var actividad = d3.scale.quantile()
                                   .domain([0,55])
                                   .range(scale_color_provinces);

           var radius = d3.scale.sqrt()
                                .domain([0, 50])
                                .range([0, 16]);

           var svg = d3.select("#mapa2010").append("svg")
                                      .attr("width", width)
                                      .attr("height", height);

           //legend to activity 
           var leg_act =  svg.append("g").attr("id", "leg_act");
           var swatch = leg_act.selectAll("rect").data(actividad.quantiles());
               swatch.enter()
                 .append("rect")
                 .attr("width", 18)
                 .attr("height", 18)
                 .attr("x", function(d,i){ return ( i*18)})
                 .attr("y", height- 30);
               swatch.style("fill", function(d,i){ return (actividad(d)) });

           //legend label to activity
           var label_act = leg_act.selectAll("text").data( actividad.quantiles());
           label_act.enter().append("text").attr("x", 0).attr("y", height ).text("Actividad");
           label_act.enter()
                    .append("text")
                    .classed("legend_activity", true)
                    .attr("x", function(d, i){ return (2 + (i * 18))})
                    .attr("y",  (height - 30));

           label_act.text( function(d,i){ 
              return d3.round(d); 
           });


           var projection = d3.geo.mercator()
                                  .center([-70, -39 ])
                                  .scale(700)
                                  .translate([ 100 , 250 ])
				  .precision(.1); 

           var path = d3.geo.path()
                            .projection(projection);

           queue()
           .defer(d3.json, "data/arg_adm1.topojson")
           .defer(d3.json, "data/eph20101centroide.geojson")
           .defer(d3.csv, "data/eph_ciudadBuenosAires_mapa.csv")
           .defer(d3.csv, "data/eph_partidosBuenosAires.csv")
           .await(ready);

           function ready(error, us, centroid, cdadbsas, bsas) {

           var tooltip = d3.select("#mapa2010").append("div")   
                       .attr("class", "tooltip")               
                       .style("opacity", 0.5);

           var scatt_width = 600;
           var scatt_height = 200;

           //scatterplot
           var scatter = svg.append("g")
                               .attr("class","scatterplot")
                               .attr("with","200px")
                               .attr("height","200px")
                               .attr("transform", function(d, i){ return ("translate("+ (width - scatt_width)+","+ (height - scatt_height) + ")"); }); 
           var circle = scatter.selectAll("circle");


           //drawing each province
           //taking from http://bost.ocks.org/mike/map/
           //and here http://techslides.com/d3-world-maps-tooltips-zooming-and-queue/
           svg.selectAll(".province")
              .data(topojson.feature(us, us.objects.ARG_adm1).features)
              .enter().append("path")
              .attr("class", function(d,i){return "province_"+d.properties.ID_1})
              .attr("d", path)
              .style("fill", function(d){ return actividad(d.properties.actividad); })
              .on("mouseover", function(d,i){
                   d3.select(this).style("fill", "rgb(2, 56, 88)");
                   var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
                   tooltip.classed("hidden", false)
                         .attr("style", "left:"+(mouse[0]+25)+"px;top:"+mouse[1]+"px")
                         .html(dohtmltooltips(d));
                   })
              .on("mouseout",  function(d,i) {
                  d3.select(this).style("fill", actividad(d.properties.actividad));
                  tooltip.classed("hidden", true);
              })
              .on("click", function(d,i){
		  console.log('Hiciste Click');
                  circle.transition()
                       .attr("r", 0)
                       .remove();

                  data = getDataForLine(d.properties.ID_1, bsas);
                  data_points = new Array();                  

                  data.forEach(function(d){
                         data_points.push([d.Periodo, d.empleo]);
                       });

                  // scale scatterplot
                  var xmax = d3.max(data_points, function(d) {return d[0]}); 
                  var xmin = d3.min(data_points, function(d) {return d[0]}); 

                  var ymin =  d3.min(data_points, function(d) {return d[1]});
                  var ymax =  d3.max(data_points, function(d) {return d[1]}); 
                  
                  //axis scatterplot
                  var ypadding = 30;
                  var xpadding = 50;


                  var xscale = d3.scale.linear()
                               .domain([xmin, xmax])
                               .range([xpadding, scatt_width + (xpadding* 2)]);           

                  var yscale = d3.scale.linear()
                               .domain([ymin, ymax])
                               .range([(scatt_height - (ypadding * 2)), ypadding]);           

                 circle = scatter.selectAll("circle")
                         .data(data_points)
                         .enter()
                         .append("circle")  
                         .attr("cx", function(d) {return xscale(parseInt(d[0]))} )
                         .attr("cy", function(d) {return (yscale(d[1])); })
                         .attr("r", 3)
                         .attr("fill","purple");

                 var xAxis = d3.svg.axis()
                                   .scale(xscale)
                                   .orient("bottom")
                                   .ticks(5);

                 var yAxis = d3.svg.axis()
                                   .scale(yscale)
                                   .orient("right")
                                   .ticks(5);


                 scatter.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + ypadding + ",0)")
                        .call(yAxis);

                 scatter.append("g").attr("class", "axis")
                                    .attr("transform", "translate(0," + (scatt_height - xpadding) + ")")
                                    .call(xAxis);
                   
              });

           //get data for update
           var getDataForLine = function(id, d) {
		  return d.filter(function(d) { return id == d.provincia_id; });
               
           }
           //drawing unemployment
           svg.selectAll(".symbol")
              .data(centroid.features)
              .enter().append("path")
              .attr("class", "symbol")
              .attr("d", path.pointRadius(
		function(d) { 
                 return radius(d.properties.desocupacion); 
                }));

           //drawing employment
           svg.selectAll(".symbol2")
              .data(centroid.features)
              .enter().append("path")
              .attr("class", "symbol2")
              .attr("d", path.pointRadius(function(d) { return radius(d.properties.empleo); }))
              .on("mouseover", function(d,i){
		var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );
                tooltip.classed("hidden", false)
                         .attr("style", "left:"+(mouse[0]+25)+"px;top:"+mouse[1]+"px")
                         .html(dohtmltooltips(d));

              })
              .on("mouseout",  function(d,i) {
                  tooltip.classed("hidden", true);
              });

           // drawing legend
           var legend = svg.selectAll(".legend")  
                           .data(Object.keys(color))
                           .enter().append("g")
                           .attr("class", "legend")
                           .attr("transform", function(d, i){ return "translate(0,"+ i * 20 + ")"; });

           legend.append("rect") 
                 .attr("x", width - 300)
                 .attr("width", 18)
                 .attr("height", 18)
                 .attr("y", 30 )
                 .style("fill", function (d, i) { return color[d]});
           legend.append("text")
                 .attr("x", width - 400)
                 .attr("y", 40)
                 .attr("dy", ".35em")
                 .text(function(d){return d;});

           //drawin tooltips
           dohtmltooltips = function(d) {
               var html;
               if (d.properties.ISO==null & d.properties.NAME_1!=null ) {
                   html = 'Provincia: ' + d.properties.NAME_1.toLowerCase();
               }
               else {
                   
                   if (d.properties.NAME_2=="Bahia Blanca") {
                       html = 'Provincia: ' + d.properties.NAME_2.toLowerCase();
                   }
                   else {
                       html = 'Provincia: ' + (d.properties.JURISDICCI).toLowerCase();
                   }
               }
               html = html + '<br/>'+' Actividad:'+ d.properties.actividad;
               html = html + '<br/>'+' Desocupación:'+ d.properties.desocupacion;
               html = html + '<br/>'+' Empleo:'+ d.properties.empleo;
               html = html + '<br/>'+' SubOcupación Demandante:'+ d.properties.subocupacion_demandante;
               return html;
           }

           } //end function ready d3
           }); //end document ready jquery
</script>
           <div class="container-fluid">
               <div class="row-fluid">
               <div class="span3">
               Esto es un Texto
               </div>
               <div class="span9" id="mapa2010">
               </div>
           </div>
</body>
</html>
